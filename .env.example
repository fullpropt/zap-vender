# ============================================
# SELF PROTEÇÃO VEICULAR - CONFIGURAÇÕES v4.0
# ============================================
# Copie este arquivo para .env e configure os valores

# Configurações do Servidor
PORT=3001
HOST=0.0.0.0
NODE_ENV=production

# Diretórios
SESSIONS_DIR=/mnt/data/sessions
UPLOAD_DIR=./uploads

# Banco de Dados (Postgres)
DATABASE_URL=postgresql://usuario:senha@host:5432/banco

# ============================================
# SEGURANÇA (OBRIGATÓRIO EM PRODUÇÃO)
# ============================================

# Chave secreta para tokens JWT (mínimo 32 caracteres)
# Gere uma chave segura: node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"
JWT_SECRET=sua-chave-secreta-super-segura-aqui-min-32-chars

# Chave para criptografia de mensagens (32 caracteres)
ENCRYPTION_KEY=chave-de-criptografia-32-caracteres

# ============================================
# WHATSAPP
# ============================================

# ID da sessão WhatsApp (não altere se não souber o que está fazendo)
WHATSAPP_DEFAULT_SESSION_ID=default_whatsapp_session
SESSION_ID=

# Persistência do auth state do Baileys: "db" (recomendado) ou "multi_file"
WHATSAPP_AUTH_STATE_DRIVER=db

# Se o driver "db" falhar, cai para multi_file automaticamente
WHATSAPP_AUTH_STATE_DB_FALLBACK_MULTI_FILE=true

# Timeout do QR Code em milissegundos (padrão: 60 segundos)
QR_TIMEOUT=60000

# Tentativas máximas de reconexão
MAX_RECONNECT_ATTEMPTS=5

# Delay entre tentativas de reconexão (ms)
RECONNECT_DELAY=3000

# Usar versao "latest" do Baileys a cada boot (NAO recomendado em producao)
WHATSAPP_USE_LATEST_BAILEYS_VERSION=false

# Fixar versao do protocolo do Baileys (formato: x.y.z) - opcional
# Exemplo: WHATSAPP_BAILEYS_VERSION=2.3000.102
WHATSAPP_BAILEYS_VERSION=

# Sincronizar historico completo ao conectar (mais pesado; pode aumentar instabilidade)
WHATSAPP_SYNC_FULL_HISTORY=false

# Processar lotes de historico entregues apos reconexao para reduzir lacunas no inbox
WHATSAPP_HISTORY_SYNC_ENABLED=true
WHATSAPP_HISTORY_SYNC_MESSAGES_LIMIT=600

# Timeouts/keepalive da conexao WhatsApp (ms)
WHATSAPP_KEEPALIVE_INTERVAL_MS=15000
WHATSAPP_CONNECT_TIMEOUT_MS=60000
WHATSAPP_DEFAULT_QUERY_TIMEOUT_MS=60000
WHATSAPP_RETRY_REQUEST_DELAY_MS=500

# Janela de aquecimento apos reconexao e backoff de disparo quando a sessao oscila (ms)
WHATSAPP_SESSION_SEND_WARMUP_MS=12000
WHATSAPP_SESSION_DISPATCH_BACKOFF_MS=60000
WHATSAPP_SESSION_RECONNECTING_RETRY_MS=20000
WHATSAPP_SESSION_WARMING_UP_RETRY_MS=10000
WHATSAPP_SESSION_DISCONNECTED_RETRY_MS=60000

# Catch-up adicional pos-reconexao (backfill via store local)
WHATSAPP_RECONNECT_CATCHUP_ENABLED=true
WHATSAPP_RECONNECT_CATCHUP_DELAY_MS=7000
WHATSAPP_RECONNECT_CATCHUP_MAX_CONVERSATIONS=40
WHATSAPP_RECONNECT_CATCHUP_MESSAGES_PER_CONVERSATION=80
WHATSAPP_RECONNECT_CATCHUP_MAX_RUNTIME_MS=45000

# ============================================
# FILA DE MENSAGENS
# ============================================

# Delay entre mensagens em massa (ms) - evita bloqueios
BULK_MESSAGE_DELAY=3000

# Máximo de mensagens por minuto
MAX_MESSAGES_PER_MINUTE=30

# Habilita worker da fila nesta instância (use "false" nos serviços de teste que compartilham o mesmo banco)
QUEUE_WORKER_ENABLED=true

# Habilita worker de automações agendadas nesta instância
SCHEDULED_AUTOMATIONS_WORKER_ENABLED=true

# Lock de liderança via Postgres para evitar múltiplos workers processando a mesma fila em serviços diferentes
POSTGRES_WORKER_LEADER_LOCK_ENABLED=true
POSTGRES_WORKER_LEADER_LOCK_POLL_MS=5000

# ============================================
# WEBHOOKS
# ============================================

# Chave secreta para validar webhooks de entrada
WEBHOOK_SECRET=webhook-secret-key

# URL padrão para webhooks de saída (opcional)
WEBHOOK_URL=

# ============================================
# RATE LIMITING
# ============================================

# Janela de tempo para rate limit (ms)
RATE_LIMIT_WINDOW_MS=60000

# Máximo de requisições por janela
RATE_LIMIT_MAX_REQUESTS=100

# ============================================
# UPLOAD DE ARQUIVOS
# ============================================

# Tamanho máximo de arquivo
MAX_FILE_SIZE=50mb

# ============================================
# FUNCIONALIDADES
# ============================================

# Habilitar construtor de fluxos
FLOW_BUILDER_ENABLED=true

# Geracao de fluxo por IA (OpenAI)
OPENAI_API_KEY=sua-chave-api-openai
OPENAI_FLOW_MODEL=gpt-5-mini
OPENAI_API_BASE_URL=https://api.openai.com/v1
OPENAI_FLOW_TIMEOUT_MS=25000

# Classificador de intencao por IA (Gemini) para gatilhos keyword
FLOW_INTENT_CLASSIFIER_ENABLED=true
GEMINI_API_KEY=sua-chave-api-gemini
GEMINI_MODEL=gemini-2.0-flash-lite
FLOW_INTENT_CLASSIFIER_MIN_CONFIDENCE=0.70
FLOW_INTENT_CLASSIFIER_STRICT=false
FLOW_INTENT_CLASSIFIER_MIN_CANDIDATES=1
FLOW_INTENT_CLASSIFIER_MAX_CANDIDATES=5
GEMINI_REQUEST_TIMEOUT_MS=4500
GEMINI_QUOTA_BACKOFF_MS=600000
FLOW_INTENT_FUZZY_THRESHOLD=0.34
FLOW_INTENT_FUZZY_MIN_SCORE=0.58
FLOW_INTENT_FUZZY_MIN_TOKEN_COVERAGE=0.45

# URL do Frontend
FRONTEND_URL=https://seu-app.railway.app

# URL publica usada para links de confirmacao de email (preferencial)
APP_URL=https://seu-app.railway.app

# ============================================
# EMAIL TRANSACIONAL (MAILMKT)
# ============================================

# URL base do MailMKT (sem o path final)
MAILMKT_URL=https://mailmkt.seudominio.com

# Chave server-to-server para integracao ZapVender -> MailMKT
MAILMKT_INTEGRATION_API_KEY=sua-chave-server-to-server

# Timeout da chamada ao MailMKT em ms (opcional)
MAILMKT_REQUEST_TIMEOUT_MS=10000

# Texto exibido no email sobre expiracao do link (opcional)
EMAIL_CONFIRMATION_EXPIRES_TEXT=24 horas

# ============================================
# CORS (Cross-Origin Resource Sharing)
# ============================================

# Origens permitidas (separadas por vírgula)
# Exemplo: http://localhost:3000,https://app.exemplo.com
# Use * para permitir todas (NÃO RECOMENDADO EM PRODUÇÃO)
CORS_ORIGINS=http://localhost:3000,http://localhost:3001
