<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Automação | SELF Proteção Veicular</title>
    <meta name="robots" content="noindex, nofollow">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/app.css">
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <style>
        .automation-card {
            background: white;
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-md);
            overflow: hidden;
            transition: all 0.2s;
        }
        .automation-card:hover { box-shadow: var(--shadow-lg); }
        .automation-header {
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
        }
        .automation-title {
            font-size: 16px;
            font-weight: 700;
            margin: 0;
        }
        .automation-body {
            padding: 20px;
        }
        .automation-trigger {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: var(--gray-50);
            border-radius: var(--border-radius);
            margin-bottom: 15px;
        }
        .automation-trigger-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }
        .automation-trigger-icon.trigger { background: rgba(var(--warning-rgb), 0.2); }
        .automation-trigger-icon.action { background: rgba(var(--success-rgb), 0.2); }
        .automation-arrow {
            text-align: center;
            color: var(--gray-400);
            font-size: 20px;
            margin: 10px 0;
        }
        .automation-footer {
            padding: 15px 20px;
            background: var(--gray-50);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .automations-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 25px;
        }
        .toggle-switch {
            position: relative;
            width: 50px;
            height: 26px;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--gray-300);
            transition: .3s;
            border-radius: 26px;
        }
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .3s;
            border-radius: 50%;
        }
        input:checked + .toggle-slider {
            background-color: var(--success);
        }
        input:checked + .toggle-slider:before {
            transform: translateX(24px);
        }
    </style>
</head>
<body>
    <button class="mobile-menu-toggle" onclick="document.querySelector('.sidebar').classList.toggle('open'); document.querySelector('.sidebar-overlay').classList.toggle('active')">☰</button>
    <div class="sidebar-overlay"></div>

    <aside class="sidebar">
        <div class="sidebar-header">
            <a href="dashboard.html" class="sidebar-logo">
                <img src="img/logo-self.png" alt="SELF"><span>SELF</span>
            </a>
        </div>
        <nav class="sidebar-nav">
            <div class="nav-section">
                <ul class="nav-menu">
                    <li class="nav-item"><a href="dashboard.html" class="nav-link"><span class="icon icon-dashboard"></span>Painel de Controle</a></li>
                    <li class="nav-item"><a href="contatos.html" class="nav-link"><span class="icon icon-contacts"></span>Contatos</a></li>
                    <li class="nav-item"><a href="campanhas.html" class="nav-link"><span class="icon icon-campaigns"></span>Campanhas</a></li>
                    <li class="nav-item"><a href="transmissao.html" class="nav-link"><span class="icon icon-broadcast"></span>Transmissão</a></li>
                </ul>
            </div>
            <div class="nav-section">
                <div class="nav-section-title">Conversas</div>
                <ul class="nav-menu">
                    <li class="nav-item"><a href="inbox.html" class="nav-link"><span class="icon icon-inbox"></span>Inbox<span class="badge" style="display:none;">0</span></a></li>
                </ul>
            </div>
            <div class="nav-section">
                <div class="nav-section-title">Automação</div>
                <ul class="nav-menu">
                    <li class="nav-item"><a href="automacao.html" class="nav-link active"><span class="icon icon-automation"></span>Automação</a></li>
                    <li class="nav-item"><a href="fluxos.html" class="nav-link"><span class="icon icon-flows"></span>Fluxos de Conversa</a></li>
                    <li class="nav-item"><a href="funil.html" class="nav-link"><span class="icon icon-funnel"></span>Funil de Vendas</a></li>
                </ul>
            </div>
            <div class="nav-section">
                <div class="nav-section-title">Sistema</div>
                <ul class="nav-menu">
                    <li class="nav-item"><a href="whatsapp.html" class="nav-link"><span class="icon icon-whatsapp"></span>WhatsApp</a></li>
                    <li class="nav-item"><a href="configuracoes.html" class="nav-link"><span class="icon icon-settings"></span>Configurações</a></li>
                </ul>
            </div>
        </nav>
        <div class="sidebar-footer">
            <div class="whatsapp-status">
                <span class="status-indicator disconnected"></span>
                <span class="whatsapp-status-text">Desconectado</span>
            </div>
            <button class="btn-logout" onclick="logout()">Sair</button>
        </div>
    </aside>

    <main class="main-content">
        <div class="page-header">
            <div class="page-title">
                <h1><span class="icon icon-automation icon-sm"></span> Automação</h1>
                <p>Configure regras automáticas para seus leads</p>
            </div>
            <div class="page-actions">
                <button class="btn btn-outline" onclick="loadAutomations()"><span class="icon icon-refresh icon-sm"></span> Atualizar</button>
                <button class="btn btn-primary" onclick="openModal('newAutomationModal')"><span class="icon icon-add icon-sm"></span> Nova Automação</button>
            </div>
        </div>

        <!-- Stats -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon primary"><span class="icon icon-automation"></span></div>
                <div class="stat-content">
                    <div class="stat-value" id="totalAutomations">0</div>
                    <div class="stat-label">Total de Automações</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon success"><span class="icon icon-check"></span></div>
                <div class="stat-content">
                    <div class="stat-value" id="activeAutomations">0</div>
                    <div class="stat-label">Ativas</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon info"><span class="icon icon-export"></span></div>
                <div class="stat-content">
                    <div class="stat-value" id="totalExecutions">0</div>
                    <div class="stat-label">Execuções (7 dias)</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon warning"><span class="icon icon-bolt"></span></div>
                <div class="stat-content">
                    <div class="stat-value" id="lastExecution">-</div>
                    <div class="stat-label">Última Execução</div>
                </div>
            </div>
        </div>

        <!-- Lista de Automações -->
        <div class="automations-grid" id="automationsList">
            <div class="empty-state" style="grid-column: 1 / -1;">
                <div class="empty-state-icon icon icon-empty icon-lg"></div>
                <p>Carregando automações...</p>
            </div>
        </div>
    </main>

    <!-- Modal: Nova Automação -->
    <div class="modal-overlay" id="newAutomationModal">
        <div class="modal modal-lg">
            <div class="modal-header">
                <h3 class="modal-title"><span class="icon icon-add icon-sm"></span> Nova Automação</h3>
                <button class="modal-close" onclick="closeModal('newAutomationModal')">×</button>
            </div>
            <div class="modal-body">
                <form id="automationForm">
                    <div class="form-group">
                        <label class="form-label required">Nome da Automação</label>
                        <input type="text" class="form-input" id="automationName" required placeholder="Ex: Boas-vindas automática">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Descrição</label>
                        <textarea class="form-textarea" id="automationDescription" rows="2" placeholder="Descreva o que esta automação faz"></textarea>
                    </div>

                    <hr style="margin: 20px 0; border: none; border-top: 1px solid var(--border-color);">
                    
                    <h4 style="margin-bottom: 15px;"><span class="icon icon-bolt icon-sm"></span> Gatilho (Quando executar)</h4>
                    
                    <div class="form-group">
                        <label class="form-label required">Tipo de Gatilho</label>
                        <select class="form-select" id="triggerType" onchange="updateTriggerOptions()">
                            <option value="new_lead">Novo lead cadastrado</option>
                            <option value="status_change">Mudança de status</option>
                            <option value="message_received">Mensagem recebida</option>
                            <option value="keyword">Palavra-chave detectada</option>
                            <option value="schedule">Agendamento</option>
                            <option value="inactivity">Inatividade</option>
                        </select>
                    </div>

                    <div class="form-group" id="triggerOptionsContainer">
                        <!-- Opções dinâmicas do gatilho -->
                    </div>

                    <hr style="margin: 20px 0; border: none; border-top: 1px solid var(--border-color);">
                    
                    <h4 style="margin-bottom: 15px;"><span class="icon icon-target icon-sm"></span> Ação (O que fazer)</h4>
                    
                    <div class="form-group">
                        <label class="form-label required">Tipo de Ação</label>
                        <select class="form-select" id="actionType" onchange="updateActionOptions()">
                            <option value="send_message">Enviar mensagem</option>
                            <option value="change_status">Alterar status</option>
                            <option value="add_tag">Adicionar tag</option>
                            <option value="start_flow">Iniciar fluxo</option>
                            <option value="notify">Notificar equipe</option>
                        </select>
                    </div>

                    <div class="form-group" id="actionOptionsContainer">
                        <!-- Opções dinâmicas da ação -->
                    </div>

                    <div class="form-group">
                        <label class="form-label">Atraso antes da execução</label>
                        <select class="form-select" id="actionDelay">
                            <option value="0">Imediatamente</option>
                            <option value="60">1 minuto</option>
                            <option value="300">5 minutos</option>
                            <option value="600">10 minutos</option>
                            <option value="1800">30 minutos</option>
                            <option value="3600">1 hora</option>
                            <option value="86400">24 horas</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('newAutomationModal')">Cancelar</button>
                <button class="btn btn-primary" onclick="saveAutomation()"><span class="icon icon-save icon-sm"></span> Salvar Automação</button>
            </div>
        </div>
    </div>

    <script src="js/app.js"></script>
    <script>
        let automations = [];

        document.addEventListener('DOMContentLoaded', () => {
            loadAutomations();
            updateTriggerOptions();
            updateActionOptions();
        });

        async function loadAutomations() {
            try {
                showLoading('Carregando automações...');
                const response = await api.get('/api/automations');
                automations = response.automations || [];
                updateStats();
                renderAutomations();
                hideLoading();
            } catch (error) {
                hideLoading();
                // Automações de exemplo
                automations = [
                    {
                        id: 1,
                        name: 'Boas-vindas',
                        description: 'Envia mensagem de boas-vindas para novos leads',
                        trigger_type: 'new_lead',
                        action_type: 'send_message',
                        is_active: true,
                        executions: 156,
                        last_execution: new Date(Date.now() - 3600000).toISOString()
                    },
                    {
                        id: 2,
                        name: 'Follow-up Automático',
                        description: 'Envia follow-up após 24h sem resposta',
                        trigger_type: 'inactivity',
                        action_type: 'send_message',
                        is_active: true,
                        executions: 89,
                        last_execution: new Date(Date.now() - 7200000).toISOString()
                    },
                    {
                        id: 3,
                        name: 'Notificação de Interesse',
                        description: 'Notifica equipe quando lead demonstra interesse',
                        trigger_type: 'keyword',
                        action_type: 'notify',
                        is_active: false,
                        executions: 45,
                        last_execution: new Date(Date.now() - 86400000).toISOString()
                    }
                ];
                updateStats();
                renderAutomations();
            }
        }

        function updateStats() {
            document.getElementById('totalAutomations').textContent = automations.length;
            document.getElementById('activeAutomations').textContent = automations.filter(a => a.is_active).length;
            document.getElementById('totalExecutions').textContent = formatNumber(automations.reduce((sum, a) => sum + (a.executions || 0), 0));
            
            const lastExec = automations.filter(a => a.last_execution).sort((a, b) => new Date(b.last_execution) - new Date(a.last_execution))[0];
            document.getElementById('lastExecution').textContent = lastExec ? timeAgo(lastExec.last_execution) : '-';
        }

        function renderAutomations() {
            const container = document.getElementById('automationsList');
            
            if (automations.length === 0) {
                container.innerHTML = `
                    <div class="empty-state" style="grid-column: 1 / -1;">
                        <div class="empty-state-icon icon icon-empty icon-lg"></div>
                        <p>Nenhuma automação criada</p>
                        <button class="btn btn-primary mt-3" onclick="openModal('newAutomationModal')"><span class="icon icon-add icon-sm"></span> Criar Automação</button>
                    </div>
                `;
                return;
            }

            container.innerHTML = automations.map(a => `
                <div class="automation-card">
                    <div class="automation-header">
                        <h3 class="automation-title">${a.name}</h3>
                        <label class="toggle-switch">
                            <input type="checkbox" ${a.is_active ? 'checked' : ''} onchange="toggleAutomation(${a.id}, this.checked)">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="automation-body">
                        <p style="color: var(--gray-600); margin-bottom: 15px; font-size: 13px;">${a.description || 'Sem descrição'}</p>
                        
                        <div class="automation-trigger">
                            <div class="automation-trigger-icon trigger"><span class="icon icon-bolt icon-sm"></span></div>
                            <div>
                                <div style="font-weight: 600; font-size: 13px;">Gatilho</div>
                                <div style="font-size: 12px; color: var(--gray-500);">${getTriggerLabel(a.trigger_type)}</div>
                            </div>
                        </div>
                        
                        <div class="automation-arrow">↓</div>
                        
                        <div class="automation-trigger">
                            <div class="automation-trigger-icon action"><span class="icon icon-target icon-sm"></span></div>
                            <div>
                                <div style="font-weight: 600; font-size: 13px;">Ação</div>
                                <div style="font-size: 12px; color: var(--gray-500);">${getActionLabel(a.action_type)}</div>
                            </div>
                        </div>
                    </div>
                    <div class="automation-footer">
                        <div style="font-size: 12px; color: var(--gray-500);">
                            <strong>${formatNumber(a.executions || 0)}</strong> execuções
                            ${a.last_execution ? `• Última: ${timeAgo(a.last_execution)}` : ''}
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-sm btn-outline" onclick="editAutomation(${a.id})"><span class="icon icon-edit icon-sm"></span></button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteAutomation(${a.id})"><span class="icon icon-delete icon-sm"></span></button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function getTriggerLabel(type) {
            const labels = {
                'new_lead': 'Novo lead cadastrado',
                'status_change': 'Mudança de status',
                'message_received': 'Mensagem recebida',
                'keyword': 'Palavra-chave detectada',
                'schedule': 'Agendamento',
                'inactivity': 'Inatividade do lead'
            };
            return labels[type] || type;
        }

        function getActionLabel(type) {
            const labels = {
                'send_message': 'Enviar mensagem',
                'change_status': 'Alterar status',
                'add_tag': 'Adicionar tag',
                'start_flow': 'Iniciar fluxo',
                'notify': 'Notificar equipe'
            };
            return labels[type] || type;
        }

        function updateTriggerOptions() {
            const type = document.getElementById('triggerType').value;
            const container = document.getElementById('triggerOptionsContainer');
            
            let html = '';
            
            switch (type) {
                case 'status_change':
                    html = `
                        <label class="form-label">De status</label>
                        <select class="form-select" id="triggerFromStatus">
                            <option value="">Qualquer</option>
                            <option value="1">Novo</option>
                            <option value="2">Em Andamento</option>
                            <option value="3">Concluído</option>
                        </select>
                        <label class="form-label mt-3">Para status</label>
                        <select class="form-select" id="triggerToStatus">
                            <option value="">Qualquer</option>
                            <option value="1">Novo</option>
                            <option value="2">Em Andamento</option>
                            <option value="3">Concluído</option>
                        </select>
                    `;
                    break;
                case 'keyword':
                    html = `
                        <label class="form-label">Palavras-chave (separadas por vírgula)</label>
                        <input type="text" class="form-input" id="triggerKeywords" placeholder="interesse, preço, quanto custa">
                    `;
                    break;
                case 'schedule':
                    html = `
                        <label class="form-label">Horário de execução</label>
                        <input type="time" class="form-input" id="triggerTime">
                        <label class="form-label mt-3">Dias da semana</label>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <label class="checkbox-wrapper"><input type="checkbox" value="1"><span class="checkbox-custom"></span>Seg</label>
                            <label class="checkbox-wrapper"><input type="checkbox" value="2"><span class="checkbox-custom"></span>Ter</label>
                            <label class="checkbox-wrapper"><input type="checkbox" value="3"><span class="checkbox-custom"></span>Qua</label>
                            <label class="checkbox-wrapper"><input type="checkbox" value="4"><span class="checkbox-custom"></span>Qui</label>
                            <label class="checkbox-wrapper"><input type="checkbox" value="5"><span class="checkbox-custom"></span>Sex</label>
                            <label class="checkbox-wrapper"><input type="checkbox" value="6"><span class="checkbox-custom"></span>Sáb</label>
                            <label class="checkbox-wrapper"><input type="checkbox" value="0"><span class="checkbox-custom"></span>Dom</label>
                        </div>
                    `;
                    break;
                case 'inactivity':
                    html = `
                        <label class="form-label">Tempo de inatividade</label>
                        <select class="form-select" id="triggerInactivity">
                            <option value="3600">1 hora</option>
                            <option value="7200">2 horas</option>
                            <option value="14400">4 horas</option>
                            <option value="28800">8 horas</option>
                            <option value="43200">12 horas</option>
                            <option value="86400">24 horas</option>
                            <option value="172800">48 horas</option>
                            <option value="604800">7 dias</option>
                        </select>
                    `;
                    break;
            }
            
            container.innerHTML = html;
        }

        function updateActionOptions() {
            const type = document.getElementById('actionType').value;
            const container = document.getElementById('actionOptionsContainer');
            
            let html = '';
            
            switch (type) {
                case 'send_message':
                    html = `
                        <label class="form-label">Mensagem</label>
                        <textarea class="form-textarea" id="actionMessage" rows="4" placeholder="Olá {{nome}}! Seja bem-vindo...

Variáveis: {{nome}}, {{veiculo}}, {{placa}}"></textarea>
                    `;
                    break;
                case 'change_status':
                    html = `
                        <label class="form-label">Novo status</label>
                        <select class="form-select" id="actionStatus">
                            <option value="1">Novo</option>
                            <option value="2">Em Andamento</option>
                            <option value="3">Concluído</option>
                            <option value="4">Perdido</option>
                        </select>
                    `;
                    break;
                case 'add_tag':
                    html = `
                        <label class="form-label">Tag</label>
                        <input type="text" class="form-input" id="actionTag" placeholder="Nome da tag">
                    `;
                    break;
                case 'start_flow':
                    html = `
                        <label class="form-label">Fluxo</label>
                        <select class="form-select" id="actionFlow">
                            <option value="">Selecione um fluxo...</option>
                        </select>
                    `;
                    break;
                case 'notify':
                    html = `
                        <label class="form-label">Mensagem de notificação</label>
                        <textarea class="form-textarea" id="actionNotification" rows="2" placeholder="Novo lead interessado: {{nome}}"></textarea>
                    `;
                    break;
            }
            
            container.innerHTML = html;
        }

        async function toggleAutomation(id, active) {
            try {
                await api.put(`/api/automations/${id}`, { is_active: active });
                const automation = automations.find(a => a.id === id);
                if (automation) automation.is_active = active;
                updateStats();
                showToast('success', 'Sucesso', `Automação ${active ? 'ativada' : 'desativada'}!`);
            } catch (error) {
                const automation = automations.find(a => a.id === id);
                if (automation) automation.is_active = active;
                updateStats();
                showToast('success', 'Sucesso', `Automação ${active ? 'ativada' : 'desativada'}!`);
            }
        }

        async function saveAutomation() {
            const name = document.getElementById('automationName').value.trim();
            const description = document.getElementById('automationDescription').value.trim();
            const triggerType = document.getElementById('triggerType').value;
            const actionType = document.getElementById('actionType').value;
            const delay = parseInt(document.getElementById('actionDelay').value);

            if (!name) {
                showToast('error', 'Erro', 'Nome é obrigatório');
                return;
            }

            const data = {
                name,
                description,
                trigger_type: triggerType,
                action_type: actionType,
                delay,
                is_active: true
            };

            try {
                showLoading('Salvando...');
                await api.post('/api/automations', data);
                closeModal('newAutomationModal');
                document.getElementById('automationForm').reset();
                await loadAutomations();
                showToast('success', 'Sucesso', 'Automação criada!');
            } catch (error) {
                hideLoading();
                // Simular sucesso
                automations.push({
                    id: automations.length + 1,
                    ...data,
                    executions: 0,
                    last_execution: null
                });
                closeModal('newAutomationModal');
                document.getElementById('automationForm').reset();
                renderAutomations();
                updateStats();
                showToast('success', 'Sucesso', 'Automação criada!');
            }
        }

        function editAutomation(id) {
            showToast('info', 'Info', 'Edição de automação em desenvolvimento');
        }

        async function deleteAutomation(id) {
            if (!confirm('Excluir esta automação?')) return;
            
            automations = automations.filter(a => a.id !== id);
            renderAutomations();
            updateStats();
            showToast('success', 'Sucesso', 'Automação excluída!');
        }
    </script>
</body>
</html>
