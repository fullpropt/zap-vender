<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Funil de Vendas | SELF Proteção Veicular</title>
    <meta name="robots" content="noindex, nofollow">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/app.css">
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <style>
        .funnel-visual {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 40px 20px;
            background: white;
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-md);
            margin-bottom: 30px;
        }
        .funnel-stage-visual {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            margin: 5px 0;
            color: white;
            font-weight: 600;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }
        .funnel-stage-visual:hover { transform: scale(1.02); }
        .funnel-stage-visual:nth-child(1) { width: 100%; background: linear-gradient(135deg, #667eea, #764ba2); border-radius: 10px 10px 0 0; }
        .funnel-stage-visual:nth-child(2) { width: 85%; background: linear-gradient(135deg, #f093fb, #f5576c); }
        .funnel-stage-visual:nth-child(3) { width: 70%; background: linear-gradient(135deg, #4facfe, #00f2fe); }
        .funnel-stage-visual:nth-child(4) { width: 55%; background: linear-gradient(135deg, #43e97b, #38f9d7); border-radius: 0 0 10px 10px; }
        .funnel-stage-info {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .funnel-stage-count { font-size: 28px; font-weight: 800; }
        .funnel-stage-name { font-size: 14px; opacity: 0.9; }
        .funnel-stage-percent { font-size: 12px; opacity: 0.8; margin-top: 5px; }
        .kanban-container {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            overflow-x: auto;
            padding-bottom: 20px;
        }
        @media (max-width: 1200px) {
            .kanban-container { grid-template-columns: repeat(2, 1fr); }
        }
        @media (max-width: 768px) {
            .kanban-container { grid-template-columns: 1fr; }
        }
        .kanban-column {
            background: var(--gray-100);
            border-radius: var(--border-radius-lg);
            min-height: 400px;
        }
        .kanban-header {
            padding: 15px 20px;
            border-bottom: 3px solid;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .kanban-header.stage-1 { border-color: #667eea; }
        .kanban-header.stage-2 { border-color: #f5576c; }
        .kanban-header.stage-3 { border-color: #4facfe; }
        .kanban-header.stage-4 { border-color: #43e97b; }
        .kanban-title { font-weight: 700; font-size: 14px; }
        .kanban-count {
            background: var(--gray-200);
            padding: 2px 10px;
            border-radius: 10px;
            font-size: 12px;
            font-weight: 600;
        }
        .kanban-body {
            padding: 15px;
            max-height: 500px;
            overflow-y: auto;
        }
        .kanban-card {
            background: white;
            border-radius: var(--border-radius);
            padding: 15px;
            margin-bottom: 10px;
            box-shadow: var(--shadow-sm);
            cursor: grab;
            transition: all 0.2s;
        }
        .kanban-card:hover { box-shadow: var(--shadow-md); transform: translateY(-2px); }
        .kanban-card.dragging { opacity: 0.5; }
        .kanban-card-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        .kanban-card-name { font-weight: 600; font-size: 14px; }
        .kanban-card-phone { font-size: 12px; color: var(--gray-500); }
        .kanban-card-vehicle { font-size: 12px; color: var(--gray-600); margin-top: 5px; }
        .kanban-card-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid var(--gray-100);
        }
        .kanban-card-date { font-size: 11px; color: var(--gray-400); }
        .stage-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: var(--gray-50);
            border-radius: var(--border-radius);
            margin-bottom: 10px;
        }
        .stage-color {
            width: 20px;
            height: 20px;
            border-radius: 5px;
        }
        .stage-item-info { flex: 1; }
    </style>
</head>
<body>
    <button class="mobile-menu-toggle" onclick="document.querySelector('.sidebar').classList.toggle('open'); document.querySelector('.sidebar-overlay').classList.toggle('active')">☰</button>
    <div class="sidebar-overlay"></div>

    <aside class="sidebar">
        <div class="sidebar-header">
            <a href="dashboard.html" class="sidebar-logo">
                <img src="img/logo-self.png" alt="SELF"><span>SELF</span>
            </a>
        </div>
        <nav class="sidebar-nav">
            <div class="nav-section">
                <ul class="nav-menu">
                    <li class="nav-item"><a href="dashboard.html" class="nav-link"><span class="icon icon-dashboard"></span>Painel de Controle</a></li>
                    <li class="nav-item"><a href="contatos.html" class="nav-link"><span class="icon icon-contacts"></span>Contatos</a></li>
                    <li class="nav-item"><a href="campanhas.html" class="nav-link"><span class="icon icon-campaigns"></span>Campanhas</a></li>
                    <li class="nav-item"><a href="transmissao.html" class="nav-link"><span class="icon icon-broadcast"></span>Transmissão</a></li>
                </ul>
            </div>
            <div class="nav-section">
                <div class="nav-section-title">Conversas</div>
                <ul class="nav-menu">
                    <li class="nav-item"><a href="inbox.html" class="nav-link"><span class="icon icon-inbox"></span>Inbox</a></li>
                </ul>
            </div>
            <div class="nav-section">
                <div class="nav-section-title">Automação</div>
                <ul class="nav-menu">
                    <li class="nav-item"><a href="automacao.html" class="nav-link"><span class="icon icon-automation"></span>Automação</a></li>
                    <li class="nav-item"><a href="fluxos.html" class="nav-link"><span class="icon icon-flows"></span>Fluxos de Conversa</a></li>
                    <li class="nav-item"><a href="funil.html" class="nav-link active"><span class="icon icon-funnel"></span>Funil de Vendas</a></li>
                </ul>
            </div>
            <div class="nav-section">
                <div class="nav-section-title">Sistema</div>
                <ul class="nav-menu">
                    <li class="nav-item"><a href="whatsapp.html" class="nav-link"><span class="icon icon-whatsapp"></span>WhatsApp</a></li>
                    <li class="nav-item"><a href="configuracoes.html" class="nav-link"><span class="icon icon-settings"></span>Configurações</a></li>
                </ul>
            </div>
        </nav>
        <div class="sidebar-footer">
            <div class="whatsapp-status">
                <span class="status-indicator disconnected"></span>
                <span class="whatsapp-status-text">Desconectado</span>
            </div>
            <button class="btn-logout" onclick="logout()">Sair</button>
        </div>
    </aside>

    <main class="main-content">
        <div class="page-header">
            <div class="page-title">
                <h1><span class="icon icon-funnel icon-sm"></span> Funil de Vendas</h1>
                <p>Visualize e gerencie seu pipeline de vendas</p>
            </div>
            <div class="page-actions">
                <button class="btn btn-outline" onclick="loadFunnel()"><span class="icon icon-refresh icon-sm"></span> Atualizar</button>
                <button class="btn btn-outline" onclick="toggleView()">
                    <span id="viewIcon"><span class="icon icon-chart-bar icon-sm"></span></span> <span id="viewText">Kanban</span>
                </button>
                <button class="btn btn-primary" onclick="openModal('configModal')"><span class="icon icon-settings icon-sm"></span> Configurar Etapas</button>
            </div>
        </div>

        <!-- Visualização do Funil -->
        <div class="funnel-visual" id="funnelVisual">
            <div class="funnel-stage-visual" onclick="filterByStage(1)">
                <div class="funnel-stage-info">
                    <div class="funnel-stage-count" id="stage1Count">0</div>
                    <div class="funnel-stage-name">Novo</div>
                    <div class="funnel-stage-percent">100%</div>
                </div>
            </div>
            <div class="funnel-stage-visual" onclick="filterByStage(2)">
                <div class="funnel-stage-info">
                    <div class="funnel-stage-count" id="stage2Count">0</div>
                    <div class="funnel-stage-name">Em Andamento</div>
                    <div class="funnel-stage-percent" id="stage2Percent">0%</div>
                </div>
            </div>
            <div class="funnel-stage-visual" onclick="filterByStage(3)">
                <div class="funnel-stage-info">
                    <div class="funnel-stage-count" id="stage3Count">0</div>
                    <div class="funnel-stage-name">Concluído</div>
                    <div class="funnel-stage-percent" id="stage3Percent">0%</div>
                </div>
            </div>
            <div class="funnel-stage-visual" onclick="filterByStage(4)">
                <div class="funnel-stage-info">
                    <div class="funnel-stage-count" id="stage4Count">0</div>
                    <div class="funnel-stage-name">Perdido</div>
                    <div class="funnel-stage-percent" id="stage4Percent">0%</div>
                </div>
            </div>
        </div>

        <!-- Kanban View -->
        <div class="kanban-container" id="kanbanView">
            <div class="kanban-column" data-stage="1">
                <div class="kanban-header stage-1">
                    <span class="kanban-title"><span class="icon icon-spark icon-sm"></span> Novo</span>
                    <span class="kanban-count" id="kanban1Count">0</span>
                </div>
                <div class="kanban-body" id="kanban1Body"></div>
            </div>
            <div class="kanban-column" data-stage="2">
                <div class="kanban-header stage-2">
                    <span class="kanban-title"><span class="icon icon-clock icon-sm"></span> Em Andamento</span>
                    <span class="kanban-count" id="kanban2Count">0</span>
                </div>
                <div class="kanban-body" id="kanban2Body"></div>
            </div>
            <div class="kanban-column" data-stage="3">
                <div class="kanban-header stage-3">
                    <span class="kanban-title"><span class="icon icon-check icon-sm"></span> Concluído</span>
                    <span class="kanban-count" id="kanban3Count">0</span>
                </div>
                <div class="kanban-body" id="kanban3Body"></div>
            </div>
            <div class="kanban-column" data-stage="4">
                <div class="kanban-header stage-4">
                    <span class="kanban-title"><span class="icon icon-close icon-sm"></span> Perdido</span>
                    <span class="kanban-count" id="kanban4Count">0</span>
                </div>
                <div class="kanban-body" id="kanban4Body"></div>
            </div>
        </div>
    </main>

    <!-- Modal: Configurar Etapas -->
    <div class="modal-overlay" id="configModal">
        <div class="modal modal-lg">
            <div class="modal-header">
                <h3 class="modal-title"><span class="icon icon-settings icon-sm"></span> Configurar Etapas do Funil</h3>
                <button class="modal-close" onclick="closeModal('configModal')">×</button>
            </div>
            <div class="modal-body">
                <p class="text-muted mb-4">Configure as etapas do seu funil de vendas. Cada etapa representa um estágio no processo de conversão.</p>
                
                <div id="stagesConfig">
                    <div class="stage-item">
                        <div class="stage-color" style="background: #667eea;"></div>
                        <div class="stage-item-info">
                            <input type="text" class="form-input" value="Novo" id="stage1Name">
                            <input type="text" class="form-input mt-2" value="Lead recém cadastrado" id="stage1Desc" placeholder="Descrição">
                        </div>
                    </div>
                    <div class="stage-item">
                        <div class="stage-color" style="background: #f5576c;"></div>
                        <div class="stage-item-info">
                            <input type="text" class="form-input" value="Em Andamento" id="stage2Name">
                            <input type="text" class="form-input mt-2" value="Em negociação" id="stage2Desc" placeholder="Descrição">
                        </div>
                    </div>
                    <div class="stage-item">
                        <div class="stage-color" style="background: #4facfe;"></div>
                        <div class="stage-item-info">
                            <input type="text" class="form-input" value="Concluído" id="stage3Name">
                            <input type="text" class="form-input mt-2" value="Venda realizada" id="stage3Desc" placeholder="Descrição">
                        </div>
                    </div>
                    <div class="stage-item">
                        <div class="stage-color" style="background: #43e97b;"></div>
                        <div class="stage-item-info">
                            <input type="text" class="form-input" value="Perdido" id="stage4Name">
                            <input type="text" class="form-input mt-2" value="Não converteu" id="stage4Desc" placeholder="Descrição">
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('configModal')">Cancelar</button>
                <button class="btn btn-primary" onclick="saveStagesConfig()"><span class="icon icon-save icon-sm"></span> Salvar Configurações</button>
            </div>
        </div>
    </div>

    <!-- Modal: Detalhes do Lead -->
    <div class="modal-overlay" id="leadModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" id="leadModalTitle"><span class="icon icon-user icon-sm"></span> Detalhes do Lead</h3>
                <button class="modal-close" onclick="closeModal('leadModal')">×</button>
            </div>
            <div class="modal-body" id="leadModalBody"></div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('leadModal')">Fechar</button>
                <button class="btn btn-whatsapp" onclick="openLeadWhatsApp()"><span class="icon icon-whatsapp icon-sm"></span> WhatsApp</button>
            </div>
        </div>
    </div>

    <script src="js/app.js"></script>
    <script>
        let leads = [];
        let currentView = 'kanban';
        let currentLead = null;

        document.addEventListener('DOMContentLoaded', () => {
            loadFunnel();
            initDragAndDrop();
        });

        async function loadFunnel() {
            try {
                showLoading('Carregando funil...');
                const response = await api.get('/api/leads');
                leads = response.leads || [];
                updateFunnelStats();
                renderKanban();
                hideLoading();
            } catch (error) {
                hideLoading();
                showToast('error', 'Erro', 'Não foi possível carregar o funil');
            }
        }

        function updateFunnelStats() {
            const total = leads.length;
            const stage1 = leads.filter(l => l.status === 1).length;
            const stage2 = leads.filter(l => l.status === 2).length;
            const stage3 = leads.filter(l => l.status === 3).length;
            const stage4 = leads.filter(l => l.status === 4).length;

            document.getElementById('stage1Count').textContent = formatNumber(stage1);
            document.getElementById('stage2Count').textContent = formatNumber(stage2);
            document.getElementById('stage3Count').textContent = formatNumber(stage3);
            document.getElementById('stage4Count').textContent = formatNumber(stage4);

            if (total > 0) {
                document.getElementById('stage2Percent').textContent = formatPercent(stage2 / total * 100);
                document.getElementById('stage3Percent').textContent = formatPercent(stage3 / total * 100);
                document.getElementById('stage4Percent').textContent = formatPercent(stage4 / total * 100);
            }

            document.getElementById('kanban1Count').textContent = stage1;
            document.getElementById('kanban2Count').textContent = stage2;
            document.getElementById('kanban3Count').textContent = stage3;
            document.getElementById('kanban4Count').textContent = stage4;
        }

        function renderKanban() {
            for (let stage = 1; stage <= 4; stage++) {
                const stageLeads = leads.filter(l => l.status === stage);
                const body = document.getElementById(`kanban${stage}Body`);
                
                if (stageLeads.length === 0) {
                    body.innerHTML = `<div class="text-center text-muted py-4">Nenhum lead</div>`;
                } else {
                    body.innerHTML = stageLeads.map(l => `
                        <div class="kanban-card" draggable="true" data-id="${l.id}" onclick="viewLead(${l.id})">
                            <div class="kanban-card-header">
                                <div class="avatar avatar-sm" style="background: ${getAvatarColor(l.name)}">${getInitials(l.name)}</div>
                                <div>
                                    <div class="kanban-card-name">${l.name || 'Sem nome'}</div>
                                    <div class="kanban-card-phone">${formatPhone(l.phone)}</div>
                                </div>
                            </div>
                            ${l.vehicle ? `<div class="kanban-card-vehicle"><span class="icon icon-car icon-sm"></span> ${l.vehicle}</div>` : ''}
                            <div class="kanban-card-footer">
                                <span class="kanban-card-date">${timeAgo(l.created_at)}</span>
                                <button class="btn btn-sm btn-whatsapp btn-icon" onclick="event.stopPropagation(); quickWhatsApp('${l.phone}')"><span class="icon icon-message icon-sm"></span></button>
                            </div>
                        </div>
                    `).join('');
                }
            }
        }

        function initDragAndDrop() {
            document.addEventListener('dragstart', (e) => {
                if (e.target.classList.contains('kanban-card')) {
                    e.target.classList.add('dragging');
                    e.dataTransfer.setData('text/plain', e.target.dataset.id);
                }
            });

            document.addEventListener('dragend', (e) => {
                if (e.target.classList.contains('kanban-card')) {
                    e.target.classList.remove('dragging');
                }
            });

            document.querySelectorAll('.kanban-body').forEach(body => {
                body.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    body.style.background = 'rgba(var(--primary-rgb), 0.1)';
                });

                body.addEventListener('dragleave', () => {
                    body.style.background = '';
                });

                body.addEventListener('drop', async (e) => {
                    e.preventDefault();
                    body.style.background = '';
                    
                    const leadId = parseInt(e.dataTransfer.getData('text/plain'));
                    const newStage = parseInt(body.parentElement.dataset.stage);
                    
                    await updateLeadStage(leadId, newStage);
                });
            });
        }

        async function updateLeadStage(leadId, newStage) {
            try {
                await api.put(`/api/leads/${leadId}`, { status: newStage });
                
                const lead = leads.find(l => l.id === leadId);
                if (lead) lead.status = newStage;
                
                updateFunnelStats();
                renderKanban();
                showToast('success', 'Sucesso', 'Lead movido!');
            } catch (error) {
                const lead = leads.find(l => l.id === leadId);
                if (lead) lead.status = newStage;
                updateFunnelStats();
                renderKanban();
                showToast('success', 'Sucesso', 'Lead movido!');
            }
        }

        function viewLead(id) {
            currentLead = leads.find(l => l.id === id);
            if (!currentLead) return;

            document.getElementById('leadModalTitle').innerHTML = `<span class="icon icon-user icon-sm"></span> ${currentLead.name || 'Lead'}`;
            document.getElementById('leadModalBody').innerHTML = `
                <div class="form-group">
                    <label class="form-label">Nome</label>
                    <p>${currentLead.name || '-'}</p>
                </div>
                <div class="form-group">
                    <label class="form-label">WhatsApp</label>
                    <p><a href="https://wa.me/55${currentLead.phone}" target="_blank" style="color: var(--whatsapp);">${formatPhone(currentLead.phone)}</a></p>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Veículo</label>
                        <p>${currentLead.vehicle || '-'}</p>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Placa</label>
                        <p>${currentLead.plate || '-'}</p>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Status</label>
                    <select class="form-select" id="leadStatus" onchange="changeLeadStatus(${currentLead.id}, this.value)">
                        <option value="1" ${currentLead.status === 1 ? 'selected' : ''}>Novo</option>
                        <option value="2" ${currentLead.status === 2 ? 'selected' : ''}>Em Andamento</option>
                        <option value="3" ${currentLead.status === 3 ? 'selected' : ''}>Concluído</option>
                        <option value="4" ${currentLead.status === 4 ? 'selected' : ''}>Perdido</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Cadastrado em</label>
                    <p>${formatDate(currentLead.created_at, 'datetime')}</p>
                </div>
            `;

            openModal('leadModal');
        }

        async function changeLeadStatus(id, status) {
            await updateLeadStage(id, parseInt(status));
        }

        function openLeadWhatsApp() {
            if (currentLead?.phone) {
                window.open(`https://wa.me/55${currentLead.phone}`, '_blank');
            }
        }

        function quickWhatsApp(phone) {
            window.open(`https://wa.me/55${phone}`, '_blank');
        }

        function toggleView() {
            const funnel = document.getElementById('funnelVisual');
            const kanban = document.getElementById('kanbanView');
            const icon = document.getElementById('viewIcon');
            const text = document.getElementById('viewText');

            if (currentView === 'kanban') {
                funnel.style.display = 'flex';
                kanban.style.display = 'none';
                icon.innerHTML = '<span class="icon icon-list icon-sm"></span>';
                text.textContent = 'Funil';
                currentView = 'funnel';
            } else {
                funnel.style.display = 'flex';
                kanban.style.display = 'grid';
                icon.innerHTML = '<span class="icon icon-chart-bar icon-sm"></span>';
                text.textContent = 'Kanban';
                currentView = 'kanban';
            }
        }

        function filterByStage(stage) {
            window.location.href = `contatos.html?status=${stage}`;
        }

        function saveStagesConfig() {
            showToast('success', 'Sucesso', 'Configurações salvas!');
            closeModal('configModal');
        }
    </script>
</body>
</html>
