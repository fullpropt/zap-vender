<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Construtor de Fluxos | SELF Proteção Veicular</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    <style>
        :root {
            --primary: #5a2a6b;
            --primary-light: #7a3a8b;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #3b82f6;
            --dark: #1e293b;
            --gray: #64748b;
            --light: #f1f5f9;
            --lighter: #f8fafc;
            --white: #ffffff;
            --border: #e2e8f0;
        }
        
        .flow-container {
            display: grid;
            grid-template-columns: 280px 1fr 320px;
            height: calc(100vh - 100px);
            gap: 0;
            background: white;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 4px 25px rgba(0,0,0,0.08);
        }
        
        /* Painel de Nós */
        .nodes-panel {
            background: var(--lighter);
            border-right: 1px solid var(--border);
            padding: 20px;
            overflow-y: auto;
        }
        
        .nodes-panel h3 {
            font-size: 14px;
            color: var(--gray);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 15px;
        }
        
        .node-category {
            margin-bottom: 25px;
        }
        
        .node-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 14px;
            background: white;
            border: 2px solid var(--border);
            border-radius: 10px;
            margin-bottom: 10px;
            cursor: grab;
            transition: all 0.2s;
        }
        
        .node-item:hover {
            border-color: var(--primary);
            box-shadow: 0 4px 12px rgba(90, 42, 107, 0.15);
        }
        
        .node-item:active {
            cursor: grabbing;
        }
        
        .node-item .icon {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }
        
        .node-item .icon.trigger { background: rgba(16, 185, 129, 0.15); }
        .node-item .icon.message { background: rgba(59, 130, 246, 0.15); }
        .node-item .icon.condition { background: rgba(245, 158, 11, 0.15); }
        .node-item .icon.action { background: rgba(139, 92, 246, 0.15); }
        .node-item .icon.delay { background: rgba(100, 116, 139, 0.15); }
        
        .node-item .info {
            flex: 1;
        }
        
        .node-item .info .name {
            font-weight: 600;
            font-size: 14px;
            color: var(--dark);
        }
        
        .node-item .info .desc {
            font-size: 12px;
            color: var(--gray);
        }
        
        /* Canvas do Fluxo */
        .flow-canvas {
            position: relative;
            background: #f8f9fa;
            background-image: 
                radial-gradient(circle, #ddd 1px, transparent 1px);
            background-size: 20px 20px;
            overflow: hidden;
        }
        
        .canvas-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            transform-origin: 0 0;
        }
        
        .flow-node {
            position: absolute;
            min-width: 200px;
            background: white;
            border: 2px solid var(--border);
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            cursor: move;
            user-select: none;
        }
        
        .flow-node.selected {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(90, 42, 107, 0.2);
        }
        
        .flow-node-header {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 14px;
            border-bottom: 1px solid var(--border);
            border-radius: 10px 10px 0 0;
        }
        
        .flow-node-header.trigger { background: rgba(16, 185, 129, 0.1); }
        .flow-node-header.message { background: rgba(59, 130, 246, 0.1); }
        .flow-node-header.condition { background: rgba(245, 158, 11, 0.1); }
        .flow-node-header.wait { background: rgba(100, 116, 139, 0.1); }
        .flow-node-header.action { background: rgba(139, 92, 246, 0.1); }
        .flow-node-header.delay { background: rgba(100, 116, 139, 0.1); }
        .flow-node-header.transfer { background: rgba(239, 68, 68, 0.1); }
        
        .flow-node-header .icon {
            font-size: 18px;
        }
        
        .flow-node-header .title {
            flex: 1;
            font-weight: 600;
            font-size: 13px;
            color: var(--dark);
        }
        
        .flow-node-header .delete-btn {
            background: none;
            border: none;
            color: var(--gray);
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            opacity: 0;
            transition: all 0.2s;
        }
        
        .flow-node:hover .delete-btn {
            opacity: 1;
        }
        
        .flow-node-header .delete-btn:hover {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
        }
        
        .flow-node-body {
            padding: 12px 14px;
            font-size: 13px;
            color: var(--gray);
            max-height: 100px;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .flow-node-ports {
            display: flex;
            justify-content: space-between;
            padding: 8px 14px;
            border-top: 1px solid var(--border);
        }
        
        .port {
            width: 14px;
            height: 14px;
            background: var(--border);
            border: 2px solid white;
            border-radius: 50%;
            cursor: crosshair;
            transition: all 0.2s;
        }
        
        .port:hover {
            background: var(--primary);
            transform: scale(1.3);
        }
        
        .port.input { margin-left: -7px; }
        .port.output { margin-right: -7px; }
        
        /* Conexões SVG */
        .connections-svg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        
        .connection-line {
            fill: none;
            stroke: var(--gray);
            stroke-width: 2;
            pointer-events: stroke;
            cursor: pointer;
        }
        
        .connection-line:hover {
            stroke: var(--danger);
            stroke-width: 3;
        }
        
        /* Painel de Propriedades */
        .properties-panel {
            background: white;
            border-left: 1px solid var(--border);
            padding: 20px;
            overflow-y: auto;
        }
        
        .properties-panel h3 {
            font-size: 16px;
            color: var(--dark);
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border);
        }
        
        .property-group {
            margin-bottom: 20px;
        }
        
        .property-group label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 8px;
        }
        
        .property-group input,
        .property-group select,
        .property-group textarea {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .property-group input:focus,
        .property-group select:focus,
        .property-group textarea:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        .property-group textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        .property-group .hint {
            font-size: 12px;
            color: var(--gray);
            margin-top: 5px;
        }
        
        .variables-list {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 10px;
        }
        
        .variable-tag {
            background: rgba(90, 42, 107, 0.1);
            color: var(--primary);
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 12px;
            cursor: pointer;
        }
        
        .variable-tag:hover {
            background: rgba(90, 42, 107, 0.2);
        }
        
        /* Toolbar */
        .flow-toolbar {
            position: absolute;
            top: 15px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            background: white;
            padding: 10px 15px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            z-index: 100;
        }
        
        .toolbar-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 14px;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .toolbar-btn.primary {
            background: var(--primary);
            color: white;
        }
        
        .toolbar-btn.primary:hover {
            background: var(--primary-light);
        }
        
        .toolbar-btn.secondary {
            background: var(--light);
            color: var(--dark);
        }
        
        .toolbar-btn.secondary:hover {
            background: var(--border);
        }
        
        /* Zoom Controls */
        .zoom-controls {
            position: absolute;
            bottom: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 5px;
            background: white;
            padding: 8px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .zoom-btn {
            width: 36px;
            height: 36px;
            border: none;
            background: var(--light);
            border-radius: 8px;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .zoom-btn:hover {
            background: var(--border);
        }
        
        .zoom-level {
            text-align: center;
            font-size: 12px;
            color: var(--gray);
            padding: 5px 0;
        }
        
        /* Empty State */
        .empty-canvas {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: var(--gray);
        }
        
        .empty-canvas .icon {
            font-size: 60px;
            margin-bottom: 15px;
            opacity: 0.5;
        }
        
        .empty-canvas h3 {
            font-size: 18px;
            color: var(--dark);
            margin-bottom: 8px;
        }
        
        .empty-canvas p {
            font-size: 14px;
        }
        
        /* Conditions Editor */
        .conditions-editor {
            margin-top: 15px;
        }
        
        .condition-row {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
            align-items: center;
        }
        
        .condition-row input {
            flex: 1;
        }
        
        .condition-row .remove-btn {
            width: 32px;
            height: 32px;
            border: none;
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
            border-radius: 6px;
            cursor: pointer;
        }
        
        .add-condition-btn {
            width: 100%;
            padding: 10px;
            border: 2px dashed var(--border);
            background: transparent;
            border-radius: 8px;
            color: var(--gray);
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .add-condition-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
        }
        
        /* Flow List Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-overlay.active {
            display: flex;
        }
        
        .modal {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow: hidden;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid var(--border);
        }
        
        .modal-header h2 {
            font-size: 18px;
            color: var(--dark);
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: var(--gray);
            cursor: pointer;
        }
        
        .modal-body {
            padding: 20px;
            max-height: 60vh;
            overflow-y: auto;
        }
        
        .flow-list-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            border: 2px solid var(--border);
            border-radius: 10px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .flow-list-item:hover {
            border-color: var(--primary);
            background: var(--lighter);
        }
        
        .flow-list-item .icon {
            width: 45px;
            height: 45px;
            background: rgba(90, 42, 107, 0.1);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }
        
        .flow-list-item .info {
            flex: 1;
        }
        
        .flow-list-item .name {
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 4px;
        }
        
        .flow-list-item .meta {
            font-size: 12px;
            color: var(--gray);
        }
        
        .flow-list-item .status {
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .flow-list-item .status.active {
            background: rgba(16, 185, 129, 0.15);
            color: var(--success);
        }
        
        .flow-list-item .status.inactive {
            background: rgba(100, 116, 139, 0.15);
            color: var(--gray);
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <nav class="sidebar">
        <div class="sidebar-logo">
            <img src="img/logo-self.png" alt="SELF" onerror="this.style.display='none'">
        </div>
        <ul class="sidebar-menu">
            <li><a href="dashboard.html"><span class="icon icon-dashboard"></span> Dashboard</a></li>
            <li><a href="funil.html"><span class="icon icon-funnel"></span> Funil de Vendas</a></li>
            <li><a href="whatsapp.html"><span class="icon icon-whatsapp"></span> WhatsApp</a></li>
            <li><a href="conversas.html"><span class="icon icon-message"></span> Conversas</a></li>
            <li><a href="flow-builder.html" class="active"><span class="icon icon-flows"></span> Fluxos</a></li>
            <li><a href="configuracoes.html"><span class="icon icon-settings"></span> Configurações</a></li>
        </ul>
        <div class="sidebar-footer">
            <a href="login.html" class="btn-logout">Sair</a>
        </div>
    </nav>
    
    <!-- Main Content -->
    <main class="main-content">
        <div class="header">
            <div class="header-title">
                <h1><span class="icon icon-flows icon-sm"></span> Construtor de Fluxos</h1>
                <p>Crie automações visuais para suas conversas</p>
            </div>
            <div class="header-actions">
                <button class="toolbar-btn secondary" onclick="openFlowsModal()">
                    <span class="icon icon-list icon-sm"></span> Meus Fluxos
                </button>
                <button class="toolbar-btn primary" onclick="createNewFlow()">
                    <span class="icon icon-add icon-sm"></span> Novo Fluxo
                </button>
            </div>
        </div>
        
        <div class="flow-container">
            <!-- Painel de Nós -->
            <div class="nodes-panel">
                <div class="node-category">
                    <h3>Gatilhos</h3>
                    <div class="node-item" draggable="true" data-type="trigger" data-subtype="new_contact">
                        <div class="icon trigger icon-user"></div>
                        <div class="info">
                            <div class="name">Novo Contato</div>
                            <div class="desc">Inicia quando um novo lead entra</div>
                        </div>
                    </div>
                    <div class="node-item" draggable="true" data-type="trigger" data-subtype="keyword">
                        <div class="icon trigger icon-lock"></div>
                        <div class="info">
                            <div class="name">Palavra-chave</div>
                            <div class="desc">Inicia com palavra específica</div>
                        </div>
                    </div>
                </div>
                
                <div class="node-category">
                    <h3>Mensagens</h3>
                    <div class="node-item" draggable="true" data-type="message">
                        <div class="icon message icon-message"></div>
                        <div class="info">
                            <div class="name">Enviar Mensagem</div>
                            <div class="desc">Envia texto ou mídia</div>
                        </div>
                    </div>
                    <div class="node-item" draggable="true" data-type="wait">
                        <div class="icon delay icon-clock"></div>
                        <div class="info">
                            <div class="name">Aguardar Resposta</div>
                            <div class="desc">Espera input do usuário</div>
                        </div>
                    </div>
                </div>
                
                <div class="node-category">
                    <h3>Lógica</h3>
                    <div class="node-item" draggable="true" data-type="condition">
                        <div class="icon condition icon-bolt"></div>
                        <div class="info">
                            <div class="name">Condição</div>
                            <div class="desc">Ramifica baseado em resposta</div>
                        </div>
                    </div>
                    <div class="node-item" draggable="true" data-type="delay">
                        <div class="icon delay icon-clock"></div>
                        <div class="info">
                            <div class="name">Delay</div>
                            <div class="desc">Aguarda tempo específico</div>
                        </div>
                    </div>
                </div>
                
                <div class="node-category">
                    <h3>Ações</h3>
                    <div class="node-item" draggable="true" data-type="transfer">
                        <div class="icon action icon-user"></div>
                        <div class="info">
                            <div class="name">Transferir</div>
                            <div class="desc">Passa para atendente</div>
                        </div>
                    </div>
                    <div class="node-item" draggable="true" data-type="tag">
                        <div class="icon action icon-tag"></div>
                        <div class="info">
                            <div class="name">Adicionar Tag</div>
                            <div class="desc">Marca o lead com tag</div>
                        </div>
                    </div>
                    <div class="node-item" draggable="true" data-type="status">
                        <div class="icon action icon-chart-bar"></div>
                        <div class="info">
                            <div class="name">Alterar Status</div>
                            <div class="desc">Muda status do lead</div>
                        </div>
                    </div>
                    <div class="node-item" draggable="true" data-type="webhook">
                        <div class="icon action icon-link"></div>
                        <div class="info">
                            <div class="name">Webhook</div>
                            <div class="desc">Envia dados para URL</div>
                        </div>
                    </div>
                    <div class="node-item" draggable="true" data-type="end">
                        <div class="icon action icon-check"></div>
                        <div class="info">
                            <div class="name">Finalizar</div>
                            <div class="desc">Encerra o fluxo</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Canvas do Fluxo -->
            <div class="flow-canvas" id="flowCanvas">
                <div class="flow-toolbar">
                    <input type="text" id="flowName" placeholder="Nome do fluxo" style="border: 2px solid var(--border); border-radius: 8px; padding: 8px 12px; width: 200px;">
                    <button class="toolbar-btn secondary" onclick="clearCanvas()"><span class="icon icon-delete icon-sm"></span> Limpar</button>
                    <button class="toolbar-btn primary" onclick="saveFlow()"><span class="icon icon-save icon-sm"></span> Salvar</button>
                </div>
                
                <svg class="connections-svg" id="connectionsSvg"></svg>
                
                <div class="canvas-container" id="canvasContainer">
                    <div class="empty-canvas" id="emptyCanvas">
                        <div class="icon icon-flows"></div>
                        <h3>Arraste os blocos para começar</h3>
                        <p>Crie seu fluxo de automação visual</p>
                    </div>
                </div>
                
                <div class="zoom-controls">
                    <button class="zoom-btn" onclick="zoomIn()">+</button>
                    <div class="zoom-level" id="zoomLevel">100%</div>
                    <button class="zoom-btn" onclick="zoomOut()">-</button>
                    <button class="zoom-btn" onclick="resetZoom()">⟲</button>
                </div>
            </div>
            
            <!-- Painel de Propriedades -->
            <div class="properties-panel" id="propertiesPanel">
                <h3>Propriedades</h3>
                <div id="propertiesContent">
                    <p style="color: var(--gray); font-size: 14px;">Selecione um bloco para editar suas propriedades</p>
                </div>
                
                <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid var(--border);">
                    <h4 style="font-size: 13px; color: var(--gray); margin-bottom: 10px;">Variáveis Disponíveis</h4>
                    <div class="variables-list">
                        <span class="variable-tag" onclick="insertVariable('nome')">{{nome}}</span>
                        <span class="variable-tag" onclick="insertVariable('telefone')">{{telefone}}</span>
                        <span class="variable-tag" onclick="insertVariable('veiculo')">{{veiculo}}</span>
                        <span class="variable-tag" onclick="insertVariable('placa')">{{placa}}</span>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <!-- Modal de Fluxos -->
    <div class="modal-overlay" id="flowsModal">
        <div class="modal">
            <div class="modal-header">
                <h2>Meus Fluxos</h2>
                <button class="modal-close" onclick="closeFlowsModal()">&times;</button>
            </div>
            <div class="modal-body" id="flowsList">
                <!-- Fluxos serão carregados aqui -->
            </div>
        </div>
    </div>
    
    <script src="js/config.js"></script>
    <script>
        // Estado do construtor
        let nodes = [];
        let edges = [];
        let selectedNode = null;
        let currentFlowId = null;
        let zoom = 1;
        let pan = { x: 0, y: 0 };
        let isDragging = false;
        let dragNode = null;
        let dragOffset = { x: 0, y: 0 };
        let isConnecting = false;
        let connectionStart = null;
        
        // Inicialização
        document.addEventListener('DOMContentLoaded', () => {
            setupDragAndDrop();
            setupCanvasEvents();
            loadFlows();
        });
        
        // Configurar drag and drop dos nós
        function setupDragAndDrop() {
            const nodeItems = document.querySelectorAll('.node-item');
            const canvas = document.getElementById('canvasContainer');
            
            nodeItems.forEach(item => {
                item.addEventListener('dragstart', (e) => {
                    e.dataTransfer.setData('nodeType', item.dataset.type);
                    e.dataTransfer.setData('nodeSubtype', item.dataset.subtype || '');
                });
            });
            
            canvas.addEventListener('dragover', (e) => {
                e.preventDefault();
            });
            
            canvas.addEventListener('drop', (e) => {
                e.preventDefault();
                const type = e.dataTransfer.getData('nodeType');
                const subtype = e.dataTransfer.getData('nodeSubtype');
                
                const rect = canvas.getBoundingClientRect();
                const x = (e.clientX - rect.left) / zoom;
                const y = (e.clientY - rect.top) / zoom;
                
                addNode(type, subtype, x, y);
            });
        }
        
        // Configurar eventos do canvas
        function setupCanvasEvents() {
            const canvas = document.getElementById('flowCanvas');
            
            canvas.addEventListener('click', (e) => {
                if (e.target === canvas || e.target.id === 'canvasContainer') {
                    deselectNode();
                }
            });
        }
        
        // Adicionar nó
        function addNode(type, subtype, x, y) {
            document.getElementById('emptyCanvas').style.display = 'none';
            
            const id = 'node_' + Date.now();
            const node = {
                id,
                type,
                subtype,
                position: { x, y },
                data: getDefaultNodeData(type, subtype)
            };
            
            nodes.push(node);
            renderNode(node);
            selectNode(id);
        }
        
        // Dados padrão do nó
        function getDefaultNodeData(type, subtype) {
            const defaults = {
                trigger: { label: subtype === 'keyword' ? 'Palavra-chave' : 'Novo Contato', keyword: '' },
                message: { label: 'Mensagem', content: 'Olá! Como posso ajudar?' },
                wait: { label: 'Aguardar Resposta', timeout: 300 },
                condition: { label: 'Condição', conditions: [] },
                delay: { label: 'Delay', seconds: 5 },
                transfer: { label: 'Transferir', message: 'Transferindo para um atendente...' },
                tag: { label: 'Adicionar Tag', tag: '' },
                status: { label: 'Alterar Status', status: 2 },
                webhook: { label: 'Webhook', url: '' },
                end: { label: 'Fim' }
            };
            return defaults[type] || { label: type };
        }
        
        // Renderizar nó
        function renderNode(node) {
            const container = document.getElementById('canvasContainer');
            
            const nodeEl = document.createElement('div');
            nodeEl.className = 'flow-node';
            nodeEl.id = node.id;
            nodeEl.style.left = node.position.x + 'px';
            nodeEl.style.top = node.position.y + 'px';
            
            const icons = {
                trigger: 'icon-bolt',
                message: 'icon-message',
                wait: 'icon-clock',
                condition: 'icon-bolt',
                delay: 'icon-clock',
                transfer: 'icon-user',
                tag: 'icon-tag',
                status: 'icon-chart-bar',
                webhook: 'icon-link',
                end: 'icon-check'
            };
            
            nodeEl.innerHTML = `
                <div class="flow-node-header ${node.type}">
                    <span class="icon ${icons[node.type] || 'icon-empty'}"></span>
                    <span class="title">${node.data.label}</span>
                    <button class="delete-btn" onclick="deleteNode('${node.id}')">&times;</button>
                </div>
                <div class="flow-node-body">
                    ${getNodePreview(node)}
                </div>
                <div class="flow-node-ports">
                    ${node.type !== 'trigger' ? '<div class="port input" data-port="input"></div>' : '<div></div>'}
                    ${node.type !== 'end' ? '<div class="port output" data-port="output"></div>' : '<div></div>'}
                </div>
            `;
            
            // Eventos de arrastar
            nodeEl.addEventListener('mousedown', (e) => {
                if (e.target.classList.contains('port')) {
                    startConnection(node.id, e.target.dataset.port);
                    return;
                }
                if (e.target.classList.contains('delete-btn')) return;
                
                isDragging = true;
                dragNode = node;
                const rect = nodeEl.getBoundingClientRect();
                dragOffset = {
                    x: e.clientX - rect.left,
                    y: e.clientY - rect.top
                };
                selectNode(node.id);
            });
            
            document.addEventListener('mousemove', (e) => {
                if (isDragging && dragNode) {
                    const canvas = document.getElementById('canvasContainer');
                    const rect = canvas.getBoundingClientRect();
                    
                    dragNode.position.x = (e.clientX - rect.left - dragOffset.x) / zoom;
                    dragNode.position.y = (e.clientY - rect.top - dragOffset.y) / zoom;
                    
                    const nodeEl = document.getElementById(dragNode.id);
                    nodeEl.style.left = dragNode.position.x + 'px';
                    nodeEl.style.top = dragNode.position.y + 'px';
                    
                    renderConnections();
                }
            });
            
            document.addEventListener('mouseup', () => {
                isDragging = false;
                dragNode = null;
            });
            
            // Eventos das portas
            nodeEl.querySelectorAll('.port').forEach(port => {
                port.addEventListener('mouseup', (e) => {
                    if (isConnecting && connectionStart) {
                        endConnection(node.id, port.dataset.port);
                    }
                });
            });
            
            container.appendChild(nodeEl);
        }
        
        // Preview do nó
        function getNodePreview(node) {
            switch (node.type) {
                case 'message':
                    return node.data.content?.substring(0, 50) + (node.data.content?.length > 50 ? '...' : '') || 'Clique para editar';
                case 'condition':
                    return `${node.data.conditions?.length || 0} condições`;
                case 'delay':
                    return `Aguardar ${node.data.seconds}s`;
                case 'trigger':
                    return node.subtype === 'keyword' ? `Palavra: ${node.data.keyword || '...'}` : 'Novo contato';
                default:
                    return '';
            }
        }
        
        // Selecionar nó
        function selectNode(id) {
            deselectNode();
            selectedNode = nodes.find(n => n.id === id);
            
            const nodeEl = document.getElementById(id);
            if (nodeEl) nodeEl.classList.add('selected');
            
            renderProperties();
        }
        
        // Deselecionar nó
        function deselectNode() {
            if (selectedNode) {
                const nodeEl = document.getElementById(selectedNode.id);
                if (nodeEl) nodeEl.classList.remove('selected');
            }
            selectedNode = null;
            document.getElementById('propertiesContent').innerHTML = '<p style="color: var(--gray); font-size: 14px;">Selecione um bloco para editar suas propriedades</p>';
        }
        
        // Deletar nó
        function deleteNode(id) {
            nodes = nodes.filter(n => n.id !== id);
            edges = edges.filter(e => e.source !== id && e.target !== id);
            
            const nodeEl = document.getElementById(id);
            if (nodeEl) nodeEl.remove();
            
            if (selectedNode?.id === id) {
                deselectNode();
            }
            
            renderConnections();
            
            if (nodes.length === 0) {
                document.getElementById('emptyCanvas').style.display = 'block';
            }
        }
        
        // Renderizar propriedades
        function renderProperties() {
            if (!selectedNode) return;
            
            const container = document.getElementById('propertiesContent');
            let html = '';
            
            html += `
                <div class="property-group">
                    <label>Nome do Bloco</label>
                    <input type="text" value="${selectedNode.data.label}" onchange="updateNodeProperty('label', this.value)">
                </div>
            `;
            
            switch (selectedNode.type) {
                case 'trigger':
                    if (selectedNode.subtype === 'keyword') {
                        html += `
                            <div class="property-group">
                                <label>Palavra-chave</label>
                                <input type="text" value="${selectedNode.data.keyword || ''}" onchange="updateNodeProperty('keyword', this.value)" placeholder="Ex: oi, olá, cotação">
                                <div class="hint">Separe múltiplas palavras por vírgula</div>
                            </div>
                        `;
                    }
                    break;
                    
                case 'message':
                    html += `
                        <div class="property-group">
                            <label>Conteúdo da Mensagem</label>
                            <textarea id="messageContent" onchange="updateNodeProperty('content', this.value)">${selectedNode.data.content || ''}</textarea>
                            <div class="hint">Use {{nome}}, {{telefone}}, etc. para personalizar</div>
                        </div>
                    `;
                    break;
                    
                case 'wait':
                    html += `
                        <div class="property-group">
                            <label>Timeout (segundos)</label>
                            <input type="number" value="${selectedNode.data.timeout || 300}" onchange="updateNodeProperty('timeout', parseInt(this.value))">
                            <div class="hint">Tempo máximo de espera pela resposta</div>
                        </div>
                    `;
                    break;
                    
                case 'condition':
                    html += `
                        <div class="property-group">
                            <label>Condições</label>
                            <div class="conditions-editor" id="conditionsEditor">
                                ${(selectedNode.data.conditions || []).map((c, i) => `
                                    <div class="condition-row">
                                        <input type="text" value="${c.value}" placeholder="Valor" onchange="updateCondition(${i}, 'value', this.value)">
                                        <button class="remove-btn" onclick="removeCondition(${i})">×</button>
                                    </div>
                                `).join('')}
                            </div>
                            <button class="add-condition-btn" onclick="addCondition()">+ Adicionar Condição</button>
                        </div>
                    `;
                    break;
                    
                case 'delay':
                    html += `
                        <div class="property-group">
                            <label>Tempo de Espera (segundos)</label>
                            <input type="number" value="${selectedNode.data.seconds || 5}" onchange="updateNodeProperty('seconds', parseInt(this.value))">
                        </div>
                    `;
                    break;
                    
                case 'transfer':
                    html += `
                        <div class="property-group">
                            <label>Mensagem de Transferência</label>
                            <textarea onchange="updateNodeProperty('message', this.value)">${selectedNode.data.message || ''}</textarea>
                        </div>
                    `;
                    break;
                    
                case 'tag':
                    html += `
                        <div class="property-group">
                            <label>Nome da Tag</label>
                            <input type="text" value="${selectedNode.data.tag || ''}" onchange="updateNodeProperty('tag', this.value)">
                        </div>
                    `;
                    break;
                    
                case 'status':
                    html += `
                        <div class="property-group">
                            <label>Novo Status</label>
                            <select onchange="updateNodeProperty('status', parseInt(this.value))">
                                <option value="1" ${selectedNode.data.status === 1 ? 'selected' : ''}>Etapa 1 - Novo</option>
                                <option value="2" ${selectedNode.data.status === 2 ? 'selected' : ''}>Etapa 2 - Em Negociação</option>
                                <option value="3" ${selectedNode.data.status === 3 ? 'selected' : ''}>Etapa 3 - Fechado</option>
                                <option value="4" ${selectedNode.data.status === 4 ? 'selected' : ''}>Etapa 4 - Perdido</option>
                            </select>
                        </div>
                    `;
                    break;
                    
                case 'webhook':
                    html += `
                        <div class="property-group">
                            <label>URL do Webhook</label>
                            <input type="url" value="${selectedNode.data.url || ''}" onchange="updateNodeProperty('url', this.value)" placeholder="https://...">
                        </div>
                    `;
                    break;
            }
            
            container.innerHTML = html;
        }
        
        // Atualizar propriedade do nó
        function updateNodeProperty(key, value) {
            if (!selectedNode) return;
            
            selectedNode.data[key] = value;
            
            // Atualizar visual
            const nodeEl = document.getElementById(selectedNode.id);
            if (nodeEl) {
                nodeEl.querySelector('.title').textContent = selectedNode.data.label;
                nodeEl.querySelector('.flow-node-body').innerHTML = getNodePreview(selectedNode);
            }
        }
        
        // Condições
        function addCondition() {
            if (!selectedNode || selectedNode.type !== 'condition') return;
            
            if (!selectedNode.data.conditions) {
                selectedNode.data.conditions = [];
            }
            
            selectedNode.data.conditions.push({ value: '', next: '' });
            renderProperties();
        }
        
        function updateCondition(index, key, value) {
            if (!selectedNode) return;
            selectedNode.data.conditions[index][key] = value;
        }
        
        function removeCondition(index) {
            if (!selectedNode) return;
            selectedNode.data.conditions.splice(index, 1);
            renderProperties();
        }
        
        // Inserir variável
        function insertVariable(variable) {
            const textarea = document.getElementById('messageContent');
            if (textarea) {
                const start = textarea.selectionStart;
                const end = textarea.selectionEnd;
                const text = textarea.value;
                textarea.value = text.substring(0, start) + `{{${variable}}}` + text.substring(end);
                textarea.focus();
                textarea.selectionStart = textarea.selectionEnd = start + variable.length + 4;
                updateNodeProperty('content', textarea.value);
            }
        }
        
        // Conexões
        function startConnection(nodeId, portType) {
            if (portType !== 'output') return;
            isConnecting = true;
            connectionStart = { nodeId, portType };
        }
        
        function endConnection(nodeId, portType) {
            if (!isConnecting || !connectionStart) return;
            if (portType !== 'input') return;
            if (connectionStart.nodeId === nodeId) return;
            
            // Verificar se conexão já existe
            const exists = edges.some(e => e.source === connectionStart.nodeId && e.target === nodeId);
            if (!exists) {
                edges.push({
                    source: connectionStart.nodeId,
                    target: nodeId
                });
                renderConnections();
            }
            
            isConnecting = false;
            connectionStart = null;
        }
        
        // Renderizar conexões
        function renderConnections() {
            const svg = document.getElementById('connectionsSvg');
            svg.innerHTML = '';
            
            edges.forEach(edge => {
                const sourceNode = document.getElementById(edge.source);
                const targetNode = document.getElementById(edge.target);
                
                if (!sourceNode || !targetNode) return;
                
                const sourcePort = sourceNode.querySelector('.port.output');
                const targetPort = targetNode.querySelector('.port.input');
                
                if (!sourcePort || !targetPort) return;
                
                const sourceRect = sourcePort.getBoundingClientRect();
                const targetRect = targetPort.getBoundingClientRect();
                const canvasRect = svg.getBoundingClientRect();
                
                const x1 = (sourceRect.left + sourceRect.width / 2 - canvasRect.left) / zoom;
                const y1 = (sourceRect.top + sourceRect.height / 2 - canvasRect.top) / zoom;
                const x2 = (targetRect.left + targetRect.width / 2 - canvasRect.left) / zoom;
                const y2 = (targetRect.top + targetRect.height / 2 - canvasRect.top) / zoom;
                
                const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                const midY = (y1 + y2) / 2;
                path.setAttribute('d', `M ${x1} ${y1} C ${x1} ${midY}, ${x2} ${midY}, ${x2} ${y2}`);
                path.setAttribute('class', 'connection-line');
                path.setAttribute('data-source', edge.source);
                path.setAttribute('data-target', edge.target);
                
                path.addEventListener('click', () => {
                    if (confirm('Remover esta conexão?')) {
                        edges = edges.filter(e => !(e.source === edge.source && e.target === edge.target));
                        renderConnections();
                    }
                });
                
                svg.appendChild(path);
            });
        }
        
        // Zoom
        function zoomIn() {
            zoom = Math.min(zoom + 0.1, 2);
            applyZoom();
        }
        
        function zoomOut() {
            zoom = Math.max(zoom - 0.1, 0.5);
            applyZoom();
        }
        
        function resetZoom() {
            zoom = 1;
            applyZoom();
        }
        
        function applyZoom() {
            const container = document.getElementById('canvasContainer');
            container.style.transform = `scale(${zoom})`;
            document.getElementById('zoomLevel').textContent = Math.round(zoom * 100) + '%';
            renderConnections();
        }
        
        // Limpar canvas
        function clearCanvas() {
            if (!confirm('Limpar todo o fluxo?')) return;
            
            nodes = [];
            edges = [];
            currentFlowId = null;
            
            document.getElementById('canvasContainer').innerHTML = `
                <div class="empty-canvas" id="emptyCanvas">
                    <div class="icon icon-flows"></div>
                    <h3>Arraste os blocos para começar</h3>
                    <p>Crie seu fluxo de automação visual</p>
                </div>
            `;
            
            document.getElementById('connectionsSvg').innerHTML = '';
            document.getElementById('flowName').value = '';
            deselectNode();
        }
        
        // Salvar fluxo
        async function saveFlow() {
            const name = document.getElementById('flowName').value.trim();
            if (!name) {
                alert('Digite um nome para o fluxo');
                return;
            }
            
            if (nodes.length === 0) {
                alert('Adicione pelo menos um bloco ao fluxo');
                return;
            }
            
            // Encontrar trigger
            const trigger = nodes.find(n => n.type === 'trigger');
            
            const flowData = {
                name,
                description: '',
                trigger_type: trigger?.subtype || 'manual',
                trigger_value: trigger?.data?.keyword || null,
                nodes,
                edges,
                is_active: 1
            };
            
            try {
                const url = currentFlowId ? `/api/flows/${currentFlowId}` : '/api/flows';
                const method = currentFlowId ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(flowData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    currentFlowId = result.flow.id;
                    alert('Fluxo salvo com sucesso!');
                } else {
                    alert('Erro ao salvar: ' + result.error);
                }
            } catch (error) {
                alert('Erro ao salvar fluxo: ' + error.message);
            }
        }
        
        // Carregar fluxos
        async function loadFlows() {
            try {
                const response = await fetch('/api/flows');
                const result = await response.json();
                
                if (result.success) {
                    renderFlowsList(result.flows);
                }
            } catch (error) {
                console.error('Erro ao carregar fluxos:', error);
            }
        }
        
        // Renderizar lista de fluxos
        function renderFlowsList(flows) {
            const container = document.getElementById('flowsList');
            
            if (flows.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--gray);">Nenhum fluxo criado ainda</p>';
                return;
            }
            
            container.innerHTML = flows.map(flow => `
                <div class="flow-list-item" onclick="loadFlow(${flow.id})">
                    <div class="icon icon-flows"></div>
                    <div class="info">
                        <div class="name">${flow.name}</div>
                        <div class="meta">Trigger: ${flow.trigger_type} | ${flow.nodes?.length || 0} blocos</div>
                    </div>
                    <span class="status ${flow.is_active ? 'active' : 'inactive'}">${flow.is_active ? 'Ativo' : 'Inativo'}</span>
                </div>
            `).join('');
        }
        
        // Carregar fluxo
        async function loadFlow(id) {
            try {
                const response = await fetch(`/api/flows/${id}`);
                const result = await response.json();
                
                if (result.success) {
                    closeFlowsModal();
                    
                    // Limpar canvas
                    document.getElementById('canvasContainer').innerHTML = '';
                    document.getElementById('connectionsSvg').innerHTML = '';
                    document.getElementById('emptyCanvas')?.remove();
                    
                    // Carregar dados
                    currentFlowId = result.flow.id;
                    nodes = result.flow.nodes || [];
                    edges = result.flow.edges || [];
                    
                    document.getElementById('flowName').value = result.flow.name;
                    
                    // Renderizar nós
                    nodes.forEach(node => renderNode(node));
                    
                    // Renderizar conexões
                    setTimeout(() => renderConnections(), 100);
                }
            } catch (error) {
                alert('Erro ao carregar fluxo: ' + error.message);
            }
        }
        
        // Criar novo fluxo
        function createNewFlow() {
            clearCanvas();
        }
        
        // Modal
        function openFlowsModal() {
            loadFlows();
            document.getElementById('flowsModal').classList.add('active');
        }
        
        function closeFlowsModal() {
            document.getElementById('flowsModal').classList.remove('active');
        }
    </script>
</body>
</html>
