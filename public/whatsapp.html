<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WhatsApp | SELF Prote√ß√£o Veicular</title>
    <meta name="robots" content="noindex, nofollow">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <link rel="stylesheet" href="css/style.css">
    <style>
        .whatsapp-container {
            display: flex;
            gap: 30px;
            flex-wrap: wrap;
        }
        
        .whatsapp-panel {
            flex: 1;
            min-width: 350px;
        }
        
        .qr-section {
            background: var(--white);
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
            text-align: center;
        }
        
        .qr-section h3 {
            font-size: 20px;
            color: var(--dark);
            margin-bottom: 20px;
        }
        
        .qr-container {
            background: var(--lighter);
            border-radius: 12px;
            padding: 30px;
            margin: 20px 0;
            min-height: 280px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .qr-container img {
            max-width: 250px;
            border-radius: 8px;
        }
        
        .qr-placeholder {
            color: var(--gray);
            font-size: 14px;
        }
        
        .qr-placeholder .icon {
            font-size: 48px;
            display: block;
            margin-bottom: 15px;
        }
        
        .connected-info {
            background: rgba(16, 185, 129, 0.1);
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .connected-info .user-avatar {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, var(--whatsapp) 0%, #128C7E 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 36px;
            color: white;
            margin: 0 auto 15px;
        }
        
        .connected-info h4 {
            color: var(--success);
            font-size: 18px;
            margin-bottom: 5px;
        }
        
        .connected-info p {
            color: var(--gray);
            font-size: 14px;
        }
        
        .instructions {
            background: var(--lighter);
            border-radius: 12px;
            padding: 20px;
            text-align: left;
            margin-top: 20px;
        }
        
        .instructions h4 {
            font-size: 14px;
            color: var(--dark);
            margin-bottom: 15px;
        }
        
        .instructions ol {
            padding-left: 20px;
            color: var(--gray);
            font-size: 13px;
            line-height: 1.8;
        }
        
        .chat-section {
            background: var(--white);
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            min-height: 600px;
        }
        
        .chat-header {
            background: linear-gradient(135deg, var(--whatsapp) 0%, #128C7E 100%);
            color: white;
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .chat-header-avatar {
            width: 45px;
            height: 45px;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }
        
        .chat-header-info h4 {
            font-size: 16px;
            margin-bottom: 3px;
        }
        
        .chat-header-info p {
            font-size: 12px;
            opacity: 0.8;
        }
        
        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #e5ddd5;
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23d4ccc4' fill-opacity='0.4'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }
        
        .chat-empty {
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--gray);
        }
        
        .chat-empty .icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.5;
        }
        
        .chat-message {
            max-width: 70%;
            margin-bottom: 12px;
            padding: 10px 14px;
            border-radius: 8px;
            font-size: 14px;
            line-height: 1.4;
            position: relative;
        }
        
        .chat-message.sent {
            background: #dcf8c6;
            margin-left: auto;
            border-bottom-right-radius: 0;
        }
        
        .chat-message.received {
            background: white;
            margin-right: auto;
            border-bottom-left-radius: 0;
        }
        
        .chat-message .time {
            font-size: 11px;
            color: var(--gray);
            text-align: right;
            margin-top: 5px;
        }
        
        .chat-contacts {
            background: var(--white);
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
            overflow: hidden;
        }
        
        .contacts-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
        }
        
        .contacts-header h3 {
            font-size: 18px;
            color: var(--dark);
        }
        
        .contacts-list {
            max-height: 500px;
            overflow-y: auto;
        }
        
        .contact-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px 20px;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .contact-item:hover {
            background: var(--lighter);
        }
        
        .contact-item.active {
            background: rgba(90, 42, 107, 0.1);
        }
        
        .contact-avatar {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 18px;
        }
        
        .contact-info {
            flex: 1;
        }
        
        .contact-info h4 {
            font-size: 15px;
            color: var(--dark);
            margin-bottom: 3px;
        }
        
        .contact-info p {
            font-size: 13px;
            color: var(--gray);
        }
        
        .contact-meta {
            text-align: right;
        }
        
        .contact-meta .date {
            font-size: 12px;
            color: var(--gray);
        }
        
        .btn-disconnect {
            background: var(--danger);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            margin-top: 15px;
            transition: all 0.2s;
        }
        
        .btn-disconnect:hover {
            background: #dc2626;
        }
        
        .btn-connect {
            background: var(--whatsapp);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            margin-top: 15px;
            transition: all 0.2s;
        }
        
        .btn-connect:hover {
            background: #1da851;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--border);
            border-top-color: var(--whatsapp);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
    </style>
</head>
<body>
    <!-- SIDEBAR -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-logo">
            <img src="img/logo-self.png" alt="SELF Prote√ß√£o Veicular">
        </div>
        
        <ul class="sidebar-menu">
            <li>
                <a href="index.html">
                    <span class="icon">üìä</span>
                    Dashboard
                </a>
            </li>
            <li>
                <a href="funil.html">
                    <span class="icon">üìà</span>
                    Funil de Vendas
                </a>
            </li>
            <li>
                <a href="whatsapp.html" class="active">
                    <span class="icon">üí¨</span>
                    WhatsApp
                </a>
            </li>
            <li>
                <a href="conversas.html">
                    <span class="icon">üí¨</span>
                    Conversas
                </a>
            </li>
            <li>
                <a href="configuracoes.html">
                    <span class="icon">‚öôÔ∏è</span>
                    Configura√ß√µes
                </a>
            </li>
        </ul>
        
        <div class="sidebar-footer">
            <button class="btn-logout" onclick="logout()">
                <span>üö™</span>
                Sair
            </button>
        </div>
    </aside>
    
    <!-- MOBILE MENU TOGGLE -->
    <button class="mobile-menu-toggle" onclick="toggleSidebar()">‚ò∞</button>
    <div class="sidebar-overlay" onclick="toggleSidebar()"></div>
    
    <!-- MAIN CONTENT -->
    <main class="main-content">
        <div class="header">
            <div class="header-title">
                <h1>üí¨ WhatsApp</h1>
                <p>Conecte e gerencie suas mensagens</p>
            </div>
            
            <div id="connection-status" class="connection-badge disconnected">
                <span class="dot"></span>
                <span id="connection-text">Desconectado</span>
            </div>
        </div>
        
        <div class="whatsapp-container">
            <!-- PAINEL DE CONEX√ÉO -->
            <div class="whatsapp-panel">
                <div class="qr-section">
                    <h3>üîó Conex√£o WhatsApp</h3>
                    
                    <!-- QR Code Container -->
                    <div class="qr-container" id="qr-container">
                        <div class="qr-placeholder" id="qr-placeholder">
                            <span class="icon">üì±</span>
                            <p>Clique em "Conectar" para gerar o QR Code</p>
                        </div>
                    </div>
                    
                    <!-- Informa√ß√µes quando conectado -->
                    <div class="connected-info" id="connected-info" style="display: none;">
                        <div class="user-avatar" id="user-avatar">üë§</div>
                        <h4 id="user-name">Usu√°rio Conectado</h4>
                        <p id="user-phone">+55 00 00000-0000</p>
                    </div>
                    
                    <button class="btn-connect" id="btn-connect" onclick="connectWhatsApp()">
                        üîå Conectar WhatsApp
                    </button>
                    
                    <button class="btn-disconnect" id="btn-disconnect" style="display: none;" onclick="disconnectWhatsApp()">
                        üîå Desconectar
                    </button>
                    
                    <div class="instructions">
                        <h4>üìã Como conectar:</h4>
                        <ol>
                            <li>Clique em "Conectar WhatsApp"</li>
                            <li>Abra o WhatsApp no seu celular</li>
                            <li>V√° em Configura√ß√µes > Dispositivos conectados</li>
                            <li>Toque em "Conectar dispositivo"</li>
                            <li>Escaneie o QR Code que aparecer</li>
                        </ol>
                    </div>
                </div>
            </div>
            
            <!-- LISTA DE CONTATOS -->
            <div class="whatsapp-panel">
                <div class="chat-contacts">
                    <div class="contacts-header">
                        <h3>üìã Contatos Recentes</h3>
                    </div>
                    <div class="contacts-list" id="contacts-list">
                        <!-- Contatos ser√£o carregados via JavaScript -->
                        <div class="chat-empty" style="padding: 40px;">
                            <span class="icon">üë•</span>
                            <p>Conecte o WhatsApp para ver os contatos</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <!-- TOAST CONTAINER -->
    <div class="toast-container" id="toast-container"></div>
    
    <script src="js/config.js"></script>
    <script>
        // Estado
        let socket = null;
        let isConnected = false;
        
        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', function() {
            initSocket();
        });
        
        // Inicializar Socket
        function initSocket() {
            socket = io(CONFIG.SOCKET_URL, {
                transports: ['websocket', 'polling'],
                reconnection: true,
                reconnectionAttempts: 10,
                reconnectionDelay: 1000
            });
            
            socket.on('connect', function() {
                console.log('Conectado ao servidor');
                socket.emit('check-session', { sessionId: CONFIG.SESSION_ID });
            });
            
            socket.on('disconnect', function() {
                console.log('Desconectado do servidor');
                updateUI(false);
            });
            
            socket.on('qr', function(data) {
                console.log('QR Code recebido');
                showQRCode(data.qr);
            });
            
            socket.on('connected', function(data) {
                console.log('WhatsApp conectado:', data);
                isConnected = true;
                updateUI(true, data.user);
                showToast('success', 'WhatsApp conectado com sucesso!');
                loadContacts();
            });
            
            socket.on('session-status', function(data) {
                console.log('Status da sess√£o:', data);
                if (data.status === 'connected') {
                    isConnected = true;
                    updateUI(true, data.user);
                    loadContacts();
                } else {
                    isConnected = false;
                    updateUI(false);
                }
            });
            
            socket.on('disconnected', function() {
                console.log('WhatsApp desconectado');
                isConnected = false;
                updateUI(false);
                showToast('info', 'WhatsApp desconectado');
            });
            
            socket.on('error', function(data) {
                console.error('Erro:', data);
                showToast('error', data.message || 'Erro na conex√£o');
            });
        }
        
        // Conectar WhatsApp
        function connectWhatsApp() {
            const btn = document.getElementById('btn-connect');
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner" style="width:16px;height:16px;border-width:2px;display:inline-block;vertical-align:middle;margin-right:8px;"></span> Conectando...';
            
            document.getElementById('qr-placeholder').innerHTML = `
                <div class="loading-spinner"></div>
                <p style="margin-top:15px;">Gerando QR Code...</p>
            `;
            
            socket.emit('start-session', { sessionId: CONFIG.SESSION_ID });
        }
        
        // Desconectar WhatsApp
        function disconnectWhatsApp() {
            if (confirm('Tem certeza que deseja desconectar o WhatsApp?')) {
                socket.emit('logout', { sessionId: CONFIG.SESSION_ID });
                isConnected = false;
                updateUI(false);
                showToast('info', 'WhatsApp desconectado');
            }
        }
        
        // Mostrar QR Code
        function showQRCode(qrData) {
            const container = document.getElementById('qr-container');
            container.innerHTML = `<img src="${qrData}" alt="QR Code">`;
            
            const btn = document.getElementById('btn-connect');
            btn.disabled = false;
            btn.innerHTML = 'üîÑ Atualizar QR Code';
        }
        
        // Atualizar UI
        function updateUI(connected, user) {
            const badge = document.getElementById('connection-status');
            const text = document.getElementById('connection-text');
            const btnConnect = document.getElementById('btn-connect');
            const btnDisconnect = document.getElementById('btn-disconnect');
            const qrContainer = document.getElementById('qr-container');
            const connectedInfo = document.getElementById('connected-info');
            
            if (connected) {
                badge.classList.remove('disconnected');
                badge.classList.add('connected');
                text.textContent = 'Conectado';
                
                btnConnect.style.display = 'none';
                btnDisconnect.style.display = 'inline-block';
                
                qrContainer.style.display = 'none';
                connectedInfo.style.display = 'block';
                
                if (user) {
                    document.getElementById('user-avatar').textContent = user.name ? user.name.charAt(0).toUpperCase() : 'üë§';
                    document.getElementById('user-name').textContent = user.name || 'Usu√°rio';
                    document.getElementById('user-phone').textContent = user.id ? '+' + user.id.split('@')[0] : '';
                }
            } else {
                badge.classList.remove('connected');
                badge.classList.add('disconnected');
                text.textContent = 'Desconectado';
                
                btnConnect.style.display = 'inline-block';
                btnConnect.disabled = false;
                btnConnect.innerHTML = 'üîå Conectar WhatsApp';
                btnDisconnect.style.display = 'none';
                
                qrContainer.style.display = 'flex';
                qrContainer.innerHTML = `
                    <div class="qr-placeholder">
                        <span class="icon">üì±</span>
                        <p>Clique em "Conectar" para gerar o QR Code</p>
                    </div>
                `;
                connectedInfo.style.display = 'none';
            }
        }
        
        // Carregar contatos (leads)
        function loadContacts() {
            const stored = localStorage.getItem(CONFIG.STORAGE_KEYS.LEADS);
            let leads = [];
            
            if (stored) {
                leads = JSON.parse(stored);
            } else {
                leads = INITIAL_LEADS;
            }
            
            const container = document.getElementById('contacts-list');
            
            if (leads.length === 0) {
                container.innerHTML = `
                    <div class="chat-empty" style="padding: 40px;">
                        <span class="icon">üë•</span>
                        <p>Nenhum contato cadastrado</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = leads.map(function(lead) {
                return `
                    <div class="contact-item" onclick="selectContact('${lead.telefone}', '${lead.nome}')">
                        <div class="contact-avatar">${lead.nome.charAt(0).toUpperCase()}</div>
                        <div class="contact-info">
                            <h4>${lead.nome}</h4>
                            <p>${lead.veiculo}</p>
                        </div>
                        <div class="contact-meta">
                            <span class="date">${lead.data.split(',')[0]}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Selecionar contato
        function selectContact(phone, name) {
            // Redirecionar para dashboard com modal aberto
            window.location.href = 'index.html?send=' + phone + '&name=' + encodeURIComponent(name);
        }
        
        // Toast
        function showToast(type, message) {
            const container = document.getElementById('toast-container');
            const icons = { success: '‚úÖ', error: '‚ùå', warning: '‚ö†Ô∏è', info: '‚ÑπÔ∏è' };
            
            const toast = document.createElement('div');
            toast.className = 'toast ' + type;
            toast.innerHTML = `
                <span class="toast-icon">${icons[type]}</span>
                <span class="toast-message">${message}</span>
                <button class="toast-close" onclick="this.parentElement.remove()">‚úï</button>
            `;
            
            container.appendChild(toast);
            setTimeout(function() { if (toast.parentElement) toast.remove(); }, 5000);
        }
        
        // Sidebar
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('active');
            document.querySelector('.sidebar-overlay').classList.toggle('active');
        }
        
        // Logout
        function logout() {
            if (confirm('Tem certeza que deseja sair?')) {
                localStorage.clear();
                window.location.href = 'index.html';
            }
        }
    </script>
</body>
</html>
